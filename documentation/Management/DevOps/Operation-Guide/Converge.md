# 聚合配置

很多时候，我们需要关注若干分组或一个应用，某一监控项的汇总值。这时候就要用到聚合配置。聚合配置的作用是将一个或多个监控指标按APP或system的范围进行聚合，监控的对象不再是单独的一台机器或者一个实例，从而实现业务层面的监控。

包括一次聚合和二次聚合，其中，

**一次聚合:**  将多个ns的监控项值汇总起来，关注汇总维度下，数据的统计情况。一次聚合是在应用范围内进行的。

**二次聚合**:  对一次聚合过的监控指标进行数学计算，以此获得与实际业务直接相关的监控指标，进一步可实现对业务情况的监控与报警。

*举例：如计算某类错误率，先通过一次聚合，聚合错误量和流量，二次聚合，计算错误率。*

## 操作指南


**（1）一次聚合**

服务树选中要聚合的应用节点，菜单选择【智能监控】-【监控配置】，点击进入聚合配置页，在左侧下拉框选择“一次聚合”，然后点击“新建”。

打开如图所示的一次聚合创建窗口，

名称：该一次聚合的名称，注意，该名称只做标识聚合配置用，聚合产生的监控项名称，是以 “要聚合的监控项名称 / 聚合维度” 的形式表示。

范围、节点：选择要进行一次聚合的应用

监控方法和监控项：选择要聚合的监控项

聚合方式：默认会按应用做聚合，此外，支持按分组、机房、及其他监控项tag维度聚合，也可自由组合多个维度

例如：按应用和分组维度，对该应用下的cpu.idle进行聚合，可以查看该应用下或某一分组下，cpu.idle的最小值。

![image](https://github.com/jdcloudcom/cn/blob/DevOps-guhezhu1/image/DevOps/Operation-Guide37.jpg)

**（2）二次聚合**

服务树选中要聚合的应用或系统节点，菜单选择【智能监控】-【监控配置】，点击进入聚合配置页，在左侧下拉框选择“二次聚合”，然后点击“新建”。

打开如图所示的二次聚合JSON配置窗口，

groupByTags的作用：参与聚合的items具有某个tag，且使用该tag的所有value值时，可在此填入key.,分隔。

derives：是进行数学计算的部分。derives中的metric：为二次聚合生成的监控项命名。名称由用户自己定义，仅支持英文、数字和下划线_。

appendTags：生成的二次聚合监控项的tag命名，格式为key=value，例如：\_group=group1。

formula: 可填入数学公式对监控指标进行运算，支持基本的数学运算\+、\-、\*。

cycle：聚合周期必须与参与计算的监控指标的采集周期完全一致，并且每一个参与计算的监控指标的采集周期必须相同。

items：以数组的形式填写参与运算的监控指标。ns内需要填写监控指标来自哪个APP。metric内填写监控项，tag不要填在此处。defaultValue是当采集时没有数据，给予一个默认值，默认为0。alias是为此算子命名一个别名，方便下面数学公式计算，t0,t1,t2......即可。useDefaultValue的值为true时，表示使用defaultValue，当为false时，相反。filterTags中填入监控指标的key和value，格式参考模板。nst表示ns的类型，为APP，无需修改。

![image](https://github.com/jdcloudcom/cn/blob/DevOps-guhezhu1/image/DevOps/Operation-Guide38.JPG)
